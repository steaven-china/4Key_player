var E=Object.defineProperty;var k=(p,t,e)=>t in p?E(p,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):p[t]=e;var d=(p,t,e)=>k(p,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();window.addEventListener("DOMContentLoaded",()=>{const p=window.innerHeight,t=document.getElementById("gameCanvas");t.style.height=p-8+"px"});window.addEventListener("resize",()=>{const p=window.innerHeight,t=document.getElementById("gameCanvas");t.style.height=p-8+"px"});document.addEventListener("DOMContentLoaded",()=>{const p=document.querySelector(".settings-panel"),t=document.querySelector(".playback-controls");p.querySelector(".settings-header").addEventListener("click",()=>{p.classList.toggle("active"),t.classList.toggle("active")});let s=!1;document.getElementById("songTitle").addEventListener("click",()=>{const i=document.getElementsByClassName("info-panel")[0],n=document.getElementsByClassName("song-info")[0],a=document.getElementById("songTitle"),o=document.getElementById("StartupCanvas");s===!1?(i.style.bottom="30px",n.style.paddingLeft="6px",p.style.opacity=0,i.style.background="rgba(248,249,250,0)",a.style.color="#505598",o.style.opacity="0",n.style.borderStyle="solid",n.style.boxShadow="#333333 -3px 4px 2px",n.style.background="rgba(156, 156, 156, 0.8)",s=!0):s===!0&&(i.style.bottom="0px",n.style.paddingLeft="0px",p.style.opacity=1,i.style.background="rgba(248, 249, 250, 0.65)",a.style.color="#34449e",o.style.opacity="inherit",n.style.borderStyle="none",n.style.boxShadow="none",n.style.background="#00000000",s=!1)})});class B{constructor(){d(this,"zip",null);d(this,"files",{});this.zip=null,this.files={}}async loadOSZ(t){const e=window.JSZip;this.zip=new e;try{const s=await this.zip.loadAsync(t);this.files={};const i=new Set,n=Object.keys(s.files);for(const[a,o]of Object.entries(s.files)){if(o.dir||a.split(".").pop().toLowerCase()!=="osu")continue;const m=await o.async("string"),c=m.match(/AudioFilename\s*:\s*(.+)/i),r=c?c[1].trim():null;this.files.beatmaps||(this.files.beatmaps=[]),this.files.beatmaps.push({filename:a,content:m,audioFilename:r}),r&&i.add(r)}for(const a of Array.from(i)){const o=n.find(l=>l.toLowerCase().endsWith(a.toLowerCase()));if(o){const m=await s.files[o].async("blob");this.files.audio={filename:o,blob:m};break}else console.warn(`谱面要求的音频文件 "${a}" 未在压缩包中找到。`)}for(const[a,o]of Object.entries(s.files)){if(o.dir)continue;const l=a.split(".").pop().toLowerCase();if(!["jpg","jpeg","png"].includes(l))continue;const m=await o.async("blob");(a.toLowerCase().includes("bg")||!this.files.background)&&(this.files.background={filename:a,blob:m})}return this.files}catch(s){throw console.error("解析OSZ文件失败:",s),s}}async loadSingleOSU(t){return new Promise((e,s)=>{const i=new FileReader;i.onload=n=>{this.files={beatmaps:[{filename:t.name,content:n.target.result}]},e(this.files)},i.onerror=s,i.readAsText(t)})}getFiles(){return this.files}}class v{constructor(){d(this,"zip",null);d(this,"files",{});this.zip=null,this.files={}}async loadPCZ(t){const e=window.JSZip;this.zip=new e;try{const s=await this.zip.loadAsync(t);this.files={};const i=Object.keys(s.files),n=[".4key.json",".json",".4key"];let a=!1;for(const[r,u]of Object.entries(s.files)){if(u.dir)continue;const h=r.toLowerCase();if(n.some(g=>h.endsWith(g))){const g=await u.async("string");this.files.beatmaps||(this.files.beatmaps=[]),this.files.beatmaps.push({filename:r,content:g}),a=!0}}if(!a){for(const[r,u]of Object.entries(s.files))if(!u.dir&&r.toLowerCase().endsWith(".osu")){const h=await u.async("string");this.files.beatmaps||(this.files.beatmaps=[]),this.files.beatmaps.push({filename:r,content:h}),a=!0}}if(!a)throw new Error("未找到谱面文件（支持的格式：.4key.json, .json, .4key, .osu）");const o=[".mp3",".wav",".ogg",".flac",".m4a",".aac"];let l=!1;for(const[r,u]of Object.entries(s.files)){if(u.dir)continue;const h=r.toLowerCase();if(o.some(g=>h.endsWith(g))){const g=await u.async("blob");this.files.audio={filename:r,blob:g},l=!0;break}}if(!l&&this.files.beatmaps&&this.files.beatmaps.length>0)try{const r=JSON.parse(this.files.beatmaps[0].content);if(r.general?.audioFilename){const u=r.general.audioFilename,h=i.find(f=>f.toLowerCase().endsWith(u.toLowerCase()));if(h){const g=await s.files[h].async("blob");this.files.audio={filename:h,blob:g},l=!0}}}catch(r){console.warn("无法从JSON谱面中解析音频文件名:",r)}const m=[".png",".jpg",".jpeg",".gif",".bmp",".webp"];let c=!1;for(const[r,u]of Object.entries(s.files)){if(u.dir)continue;const h=r.toLowerCase();if(m.some(g=>h.endsWith(g))){const g=await u.async("blob"),y=h.includes("bg")||h.includes("background");if((y||!this.files.background)&&(this.files.background={filename:r,blob:g},y)){c=!0;break}}}if(!c&&this.files.background&&(c=!0),!c&&this.files.beatmaps&&this.files.beatmaps.length>0)try{const r=JSON.parse(this.files.beatmaps[0].content);if(r.events?.background?.filename){const u=r.events.background.filename,h=i.find(f=>f.toLowerCase().endsWith(u.toLowerCase()));if(h){const g=await s.files[h].async("blob");this.files.background={filename:h,blob:g}}}}catch(r){console.warn("无法从JSON谱面中解析背景文件名:",r)}return this.files}catch(s){throw console.error("解析PCZ文件失败:",s),s}}async loadSingleJSON(t){return new Promise((e,s)=>{const i=new FileReader;i.onload=n=>{this.files={beatmaps:[{filename:t.name,content:n.target.result}]},e(this.files)},i.onerror=s,i.readAsText(t)})}getFiles(){return this.files}static isPCZFile(t){return t.name.split(".").pop().toLowerCase()==="pcz"}static isJSONBeatmapFile(t){const e=t.name.toLowerCase();return e.endsWith(".4key.json")||e.endsWith(".json")||e.endsWith(".4key")}}class P{constructor(){d(this,"beatmap",null);this.beatmap=null}getBeatmap(){return this.beatmap}clampSV(t){return Math.max(.001,Math.min(30,t))}calculateKeyCount(t){const e=t.map(i=>Math.floor(i.x*8/512));return new Set(e).size}convertTo4Key(t,e){const s=n=>Math.floor(n*e/512),i=n=>Math.floor(n*4/e);return t.map(n=>({...n,x:Math.floor(n.x*4/e),column:i(s(n.x))}))}calculateKeyGroups(t){let e=0,s=-1/0;const i=150;for(const n of t)n.time-s>i&&e++,n.keyGroup=e,s=n.time}calculateKeyGroupsByMeasure(t,e){let s=0,i=0;for(const n of t){for(;i<e.length-1&&n.time>=e[i+1];)i++,s++;n.keyGroup=s}}calculateKeyGroupsByMeasureGroups(t,e,s=8){let i=0,n=0,a=0;for(const o of t){for(;n<e.length-1&&o.time>=e[n+1];)n++,a++,a>=s&&(i++,a=0);o.keyGroup=i}}calculateKeyGroupsBySubMeasures(t,e,s=16){if(e.length<2){this.calculateKeyGroups(t);return}let i=0;const n=8;for(const a of t){for(;i<e.length-1&&a.time>=e[i+1];)i++;const o=e[i],m=(i+1<e.length?e[i+1]:o+6e4/120*4)-o,c=a.time-o,r=Math.floor(c/m*s),u=i*s+r,h=s/n;a.keyGroup=Math.floor(u/h)}}buildSVSegments(t){const e=t.rawTimingPointsForSV||t.timingPoints,s=1,i=new Set;i.add(0);for(const r of e)i.add(r.time);const n=r=>{let u=s;for(let h=e.length-1;h>=0;h--){const f=e[h];if(f.time<=r){f.uninherited||(u=this.clampSV(-100/f.beatLength));break}}return u},a=Array.from(i).sort((r,u)=>r-u),o=[],l=[];for(let r=0;r<a.length;r++){const u=a[r],h=r+1<a.length?a[r+1]:1/0,f=n(u);o.push({start:u,end:h,sv:f})}const m=[];for(const r of o)if(m.length===0)m.push({...r});else{const u=m[m.length-1];Math.abs(u.sv-r.sv)<1e-6&&u.end===r.start?u.end=r.end:m.push({...r})}let c=0;for(const r of m){l.push(c);const u=r.end===1/0?0:r.end-r.start,h=r.sv*u;c+=h}t.svSegments=m,t.svCumAreas=l}buildCombinedSegments(t){const e=t.rawTimingPointsForSV||t.timingPoints,s=1,i=e.find(h=>h.uninherited),n=i?6e4/i.beatLength:120,a=new Set;a.add(0);for(const h of e)a.add(h.time);const o=h=>{let f=n,g=s;for(let y=e.length-1;y>=0;y--){const b=e[y];if(b.time<=h){b.uninherited?f=6e4/b.beatLength:g=this.clampSV(-100/b.beatLength);break}}return{bpm:f,sv:g}},l=Array.from(a).sort((h,f)=>h-f),m=[],c=[];for(let h=0;h<l.length;h++){const f=l[h],g=h+1<l.length?l[h+1]:1/0,{bpm:y,sv:b}=o(f),w=b*(y/n);m.push({start:f,end:g,sv:w})}const r=[];for(const h of m)if(r.length===0)r.push({...h});else{const f=r[r.length-1];Math.abs(f.sv-h.sv)<1e-6&&f.end===h.start?f.end=h.end:r.push({...h})}let u=0;for(const h of r){c.push(u);const f=h.end===1/0?0:h.end-h.start,g=h.sv*f;u+=g}t.combinedSegments=r,t.combinedCumAreas=c}alignTimingPoints(t){const e=[],s=new Set;for(const a of t)s.has(a.time)||(s.add(a.time),e.push(a));e.sort((a,o)=>a.time-o.time);const i=[];let n=120;for(const a of e)if(a.uninherited)n=6e4/a.beatLength,i.push(a);else{const l=6e4/n;i.push({...a,beatLength:l})}t.length=0,t.push(...i)}calculateMeasures(t){const s=t.timingPoints.filter(a=>a.uninherited);if(s.length===0)return;const i=t.hitObjects.reduce((a,o)=>{const l=o.isLongNote?o.endTime:o.time;return Math.max(a,l)},0),n=[];for(let a=0;a<s.length;a++){const o=s[a],l=o.time,c=a+1<s.length?s[a+1].time:i+1e4,r=6e4/Math.abs(o.beatLength)*o.meter;let u=l;for(;u<c;)n.push(u),u+=r}t.measures=n}}class S extends P{parse(t){const e=t.split(`
`),s={metadata:{},general:{},difficulty:{},timingPoints:[],hitObjects:[],keyCount:0,svSegments:[],svCumAreas:[],combinedSegments:[],combinedCumAreas:[]};let i="";for(let a of e){if(a=a.trim(),a.startsWith("[")&&a.endsWith("]")){i=a.slice(1,-1);continue}if(!(a===""||a.startsWith("//")))switch(i){case"General":this.parseKeyValue(a,s.general);break;case"Metadata":this.parseKeyValue(a,s.metadata);break;case"Difficulty":this.parseDifficulty(a,s.difficulty);break;case"TimingPoints":this.parseTimingPoint(a,s.timingPoints);break;case"HitObjects":this.parseHitObject(a,s.hitObjects);break}}const n=s.timingPoints.map(a=>({...a}));if(this.alignTimingPoints(s.timingPoints),s.rawTimingPointsForSV=n,this.calculateMeasures(s),s.keyCount=this.calculateKeyCount(s.hitObjects),s.keyCount!==4)s.hitObjects=this.convertTo4Key(s.hitObjects,s.keyCount),s.keyCount=4;else for(const a of s.hitObjects)a.column=Math.floor(a.x*4/512);return s.measures&&s.measures.length>0?this.calculateKeyGroupsBySubMeasures(s.hitObjects,s.measures,16):this.calculateKeyGroups(s.hitObjects),this.buildSVSegments(s),this.buildCombinedSegments(s),this.beatmap=s,s}parseKeyValue(t,e){const[s,...i]=t.split(":");if(!s)return;const n=i.join(":").trim();n!==""&&(e[s.trim()]=n.trim())}parseDifficulty(t,e){const[s,...i]=t.split(":");if(!s)return;const n=i.join(":").trim(),a=parseFloat(n);e[s.trim()]=isNaN(a)?n:a}parseTimingPoint(t,e){const s=t.split(",");if(s.length>=2){const i=parseFloat(s[0]),n=parseFloat(s[1]),a=parseInt(s[2])||4,o=s.length<7?!0:s[6]==="1";e.push({time:i,beatLength:n,meter:a,uninherited:o})}}parseHitObject(t,e){const s=t.split(",");if(s.length>=4){const i=parseInt(s[0],10),n=parseInt(s[2],10),a=parseInt(s[3],10),o=!!(a&128),l={x:i,time:n,type:a,isLongNote:o,endTime:n,column:0,keyGroup:0};if(o&&s.length>=6){const m=s[5].split(":")[0];l.endTime=parseInt(m,10)}e.push(l)}}}class I extends P{parse(t){let e;try{e=JSON.parse(t)}catch(n){throw new Error(`Invalid JSON format: ${n}`)}if(!e.objects||!e.objects.hitObjects)throw new Error("Missing required fields: objects.hitObjects");const s={metadata:this.convertMetadata(e.metadata||{}),general:this.convertGeneral(e.general||{}),difficulty:this.convertDifficulty(e.difficulty||{}),timingPoints:this.convertTimingPoints(e.timing),hitObjects:this.convertHitObjects(e.objects.hitObjects),keyCount:e.objects.keyCount||4,svSegments:[],svCumAreas:[],combinedSegments:[],combinedCumAreas:[]};if(e.calculated?.svSegments&&e.calculated.svCumAreas?(s.svSegments=e.calculated.svSegments,s.svCumAreas=e.calculated.svCumAreas):(s.rawTimingPointsForSV=[...s.timingPoints],this.alignTimingPoints(s.timingPoints),this.buildSVSegments(s)),e.calculated?.combinedSegments&&e.calculated.combinedCumAreas?(s.combinedSegments=e.calculated.combinedSegments,s.combinedCumAreas=e.calculated.combinedCumAreas):this.buildCombinedSegments(s),e.calculated?.measures?s.measures=e.calculated.measures:this.calculateMeasures(s),s.keyCount!==4)s.hitObjects=this.convertTo4Key(s.hitObjects,s.keyCount),s.keyCount=4;else for(const n of s.hitObjects)n.column===void 0&&(n.column=Math.floor(n.x*4/512));return e.objects.keyGroups&&e.objects.keyGroups.length>0?this.applyKeyGroupsFromJSON(s.hitObjects,e.objects.keyGroups):s.measures&&s.measures.length>0?this.calculateKeyGroupsBySubMeasures(s.hitObjects,s.measures,16):this.calculateKeyGroups(s.hitObjects),this.beatmap=s,s}convertMetadata(t){const e={};return t.title&&(e.Title=t.title),t.titleUnicode&&(e.TitleUnicode=t.titleUnicode),t.artist&&(e.Artist=t.artist),t.artistUnicode&&(e.ArtistUnicode=t.artistUnicode),t.creator&&(e.Creator=t.creator),t.version&&(e.Version=t.version),t.source&&(e.Source=t.source),t.tags&&(e.Tags=t.tags.join(" ")),t.beatmapId&&(e.BeatmapID=t.beatmapId.toString()),t.beatmapSetId&&(e.BeatmapSetID=t.beatmapSetId.toString()),e}convertGeneral(t){const e={};return t&&(t.audioFilename&&(e.AudioFilename=t.audioFilename),t.audioLeadIn!==void 0&&(e.AudioLeadIn=t.audioLeadIn.toString()),t.previewTime!==void 0&&(e.PreviewTime=t.previewTime.toString()),t.countdown!==void 0&&(e.Countdown=t.countdown.toString()),t.sampleSet&&(e.SampleSet=t.sampleSet),t.stackLeniency!==void 0&&(e.StackLeniency=t.stackLeniency.toString()),t.mode!==void 0&&(e.Mode=t.mode.toString()),t.letterboxInBreaks!==void 0&&(e.LetterboxInBreaks=t.letterboxInBreaks?"1":"0"),t.useSkinSprites!==void 0&&(e.UseSkinSprites=t.useSkinSprites?"1":"0"),t.overlayPosition&&(e.OverlayPosition=t.overlayPosition)),e}convertDifficulty(t){const e={};return t.hpDrainRate!==void 0&&(e.HPDrainRate=t.hpDrainRate),t.circleSize!==void 0&&(e.CircleSize=t.circleSize),t.overallDifficulty!==void 0&&(e.OverallDifficulty=t.overallDifficulty),t.approachRate!==void 0&&(e.ApproachRate=t.approachRate),t.sliderMultiplier!==void 0&&(e.SliderMultiplier=t.sliderMultiplier),t.sliderTickRate!==void 0&&(e.SliderTickRate=t.sliderTickRate),e}convertTimingPoints(t){return!t||!t.points?[]:t.points.map(e=>({time:e.time,beatLength:e.beatLength,meter:e.meter||4,uninherited:e.uninherited}))}convertHitObjects(t){return t.map(e=>{const s={x:e.x||0,time:e.type==="longNote"&&e.startTime||e.time,type:this.getObjectType(e.type),isLongNote:e.type==="longNote",endTime:e.type==="longNote"&&e.endTime||e.time,column:e.column||0,keyGroup:e.extras?.keyGroup||0};return e.type==="longNote"&&!e.endTime&&(console.warn("Long note missing endTime, using time + 100ms"),s.endTime=s.time+100),s})}getObjectType(t){switch(t){case"circle":return 1;case"longNote":return 128;case"slider":return 2;default:return 1}}applyKeyGroupsFromJSON(t,e){if(!e)return;const s=new Map;t.forEach((n,a)=>{s.set(`obj_${a}`,n)});for(const n of e)if(n.objects)for(const a of n.objects){const o=s.get(a);o&&(o.keyGroup=n.id)}let i=Math.max(...e.map(n=>n.id))+1;for(const n of t)n.keyGroup===0&&(n.keyGroup=i++)}}class C{static createParser(t){const e=t.trim();return this.isJSONFormat(e)?new I:this.isOSUFormat(e)?new S:(console.warn("无法确定谱面格式，默认使用OSU解析器"),new S)}static isJSONFormat(t){try{if(!t.startsWith("{"))return!1;const e=JSON.parse(t);if(!e||typeof e!="object")return!1;const s="formatVersion"in e,i="objects"in e&&e.objects&&typeof e.objects=="object"&&"hitObjects"in e.objects;return s||i}catch{return!1}}static isOSUFormat(t){const e=t.split(`
`).slice(0,10),s=e.some(a=>a.toLowerCase().includes("osu file format v")),i=e.some(a=>a.trim().startsWith("[")&&a.trim().endsWith("]")),n=e.some(a=>{const o=a.trim();return o.includes(":")&&!o.startsWith("//")&&o!==""});return s||i&&n}static createParserByExtension(t){const e=t.toLowerCase().split(".").pop();switch(e){case"json":case"4key":case"4keyjson":return new I;case"osu":return new S;case"osz":return console.warn(".osz files need to be extracted first, using OSU parser for internal .osu files"),new S;default:return console.warn(`Unknown file extension: .${e}, defaulting to OSU parser`),new S}}static parse(t){return this.createParser(t).parse(t)}static parseAll(t){return t.map(e=>this.parse(e))}}class T{constructor(){d(this,"audio",null);d(this,"audioContext",null);d(this,"sourceNode",null);d(this,"onEnded",null);d(this,"isPlaying",!1);d(this,"startTime",0);d(this,"pauseTime",0);d(this,"playbackRate",1);d(this,"soundPool",new Map);d(this,"poolSize",10);this.initAudioContext()}initAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(t){console.warn("Web Audio API not supported",t)}}async loadAudio(t){return new Promise((e,s)=>{const i=URL.createObjectURL(t);this.audio=new Audio(i),this.audio.volume=.26,this.audio.addEventListener("loadeddata",()=>{e(this.audio)}),this.audio.addEventListener("error",s)})}async loadSound(t,e){if(this.audioContext)try{const i=await(await fetch(e)).arrayBuffer(),n=await this.audioContext.decodeAudioData(i);this.soundPool.set(t,{buffer:n,instances:[]})}catch(s){console.error(`Failed to load sound "${t}":`,s)}}async playSound(t,e=1){if(!this.audioContext||!this.soundPool.has(t))return;this.audioContext.state==="suspended"&&await this.audioContext.resume();const s=this.soundPool.get(t);return new Promise(i=>{setTimeout(()=>{const n=this.audioContext.createBufferSource();n.buffer=s.buffer;const a=this.audioContext.createGain();a.gain.value=e,n.connect(a),a.connect(this.audioContext.destination),n.onended=()=>{n.disconnect(),a.disconnect(),i()},n.start(0)},0)})}playSound_nonBlocking(t,e=1){this.playSound(t,e).catch(s=>{console.warn(`Sound playback error: ${s}`)})}play(t=0){this.audio&&(this.audio.currentTime=t,this.audio.playbackRate=this.playbackRate,this.audio.play(),this.isPlaying=!0,this.startTime=t,this.audio.onended=()=>{this.isPlaying=!1,this.onEnded&&this.onEnded()})}pause(){this.audio&&(this.audio.pause(),this.pauseTime=this.audio.currentTime,this.isPlaying=!1)}stop(){this.audio&&(this.audio.pause(),this.audio.currentTime=0,this.isPlaying=!1,this.pauseTime=0)}setPlaybackRate(t){this.playbackRate=t,this.audio&&(this.audio.playbackRate=t)}getCurrentTime(){return this.audio?this.audio.currentTime*1e3:0}getDuration(){return this.audio?this.audio.duration:0}getIsPlaying(){return this.isPlaying}dispose(){this.soundPool.clear(),this.audioContext&&this.audioContext.close()}}class F{constructor(t){d(this,"canvas");d(this,"ctx");d(this,"offscreenCanvas");d(this,"offscreenCtx");d(this,"beatmap",null);d(this,"currentTime",0);d(this,"scrollSpeed",800);d(this,"showSV",!0);d(this,"showKeyGroup",!0);d(this,"useBPMScaling",!1);d(this,"measureOffset",0);d(this,"laneWidth",120);d(this,"laneCount",4);d(this,"judgmentLineY",0);d(this,"visibleLeadTime",5e3);d(this,"visibleTrail",46);d(this,"bgImage",null);d(this,"bgReady",!1);d(this,"bgAlpha",.15);d(this,"ambientParticles",[]);d(this,"hitEffects",[]);d(this,"ambientCount",160);d(this,"pressedLanes",new Set);d(this,"keyGroupColors",["#FF6B6B","#4ECDC4","#45B7D1","#FFA07A","#98D8C8","#F7DC6F","#BB8FCE","#85C1E2"]);d(this,"stats",{score:0,combo:0,acc:100,judgements:{}});d(this,"fps",0);d(this,"frameCount",0);d(this,"lastFpsUpdate",Date.now());d(this,"particleWorker",null);d(this,"_lastFrameTime",performance.now());d(this,"_accum",0);d(this,"pendingTasks",[]);d(this,"disableVsync",!1);d(this,"renderLoopId",null);d(this,"targetFPS",360);d(this,"lastRenderTime",0);d(this,"renderAccumulator",0);d(this,"fixedTimeStep",1/60);d(this,"isRendering",!1);d(this,"width",0);d(this,"height",0);this.canvas=t,this.ctx=t.getContext("2d",{alpha:!1}),this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),this.initWorker(),this._lastFrameTime=performance.now(),this._accum=0,this.pendingTasks=[],this.useBPMScaling=!0}initWorker(){try{this.particleWorker=new Worker(new URL(""+new URL("particleWorker-BbBKram7.js",import.meta.url).href,import.meta.url)),this.particleWorker.onmessage=t=>{const{type:e,data:s}=t.data;switch(e){case"ambientInit":case"ambientUpdate":this.ambientParticles=s;break;case"hitCreate":case"hitUpdate":this.hitEffects=s;break}},this.particleWorker.postMessage({type:"initAmbient",data:{count:this.ambientCount,width:this.width,height:this.height}})}catch(t){console.warn("Worker initialization failed, using fallback",t),this.initAmbientParticles()}}async createHitEffect(t,e){const s=this.laneWidth*this.laneCount,n=Math.random()*10+(this.width-s)/2+t*this.laneWidth+this.laneWidth/2,a=this.judgmentLineY,o=this.isValidColor(e)?e:"#FFFFFF";return this.particleWorker?new Promise(l=>{this.particleWorker.postMessage({type:"createHit",data:{x:n,y:a,color:o,laneWidth:this.laneWidth}}),l()}):this.createHitEffectFallback(t,e)}isValidColor(t){return!t||typeof t!="string"?!1:/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(t)}async createHitEffectFallback(t,e){return new Promise(s=>{setTimeout(()=>{const i=this.laneWidth*this.laneCount,a=Math.random()*10+(this.width-i)/2+t*this.laneWidth+this.laneWidth/2,o=this.judgmentLineY,l=e||"#FFFFFF",m=30;for(let c=0;c<m;c++){const r=-Math.PI/2+(Math.random()-.5)*(Math.PI/2),h=.8*Math.sqrt(Math.random()),f=Math.cos(r)*h*.8,g=Math.sin(r)*h;this.hitEffects.push({x:a,y:o,vx:f,vy:g,life:1.5,decay:.02+Math.random()*.02,size:this.laneWidth/2-5+Math.random()*7,color:l})}this.hitEffects.push({x:a,y:o,vx:-.2,vy:0,life:10,decay:.6,size:Math.random()*10,color:l,isExplosion:!0}),s()},0)})}resizeCanvas(){const t=this.canvas.getBoundingClientRect(),e=window.devicePixelRatio||1;this.canvas.width=t.width*e,this.canvas.height=t.height*e,this.canvas.style.width=t.width+"px",this.canvas.style.height=t.height+"px",this.offscreenCanvas.width=this.canvas.width,this.offscreenCanvas.height=this.canvas.height,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(e,e),this.offscreenCtx.setTransform(1,0,0,1,0,0),this.offscreenCtx.scale(e,e),this.width=t.width,this.height=t.height,this.judgmentLineY=this.height-100}setBeatmap(t){this.beatmap=t}setMeasureOffset(t){this.measureOffset=t}getMeasureOffset(){return this.measureOffset}setScrollSpeed(t){this.scrollSpeed=Math.max(200,t*40)}setShowSV(t){this.showSV=t}setShowKeyGroup(t){this.showKeyGroup=t}setUseBPMScaling(t){this.useBPMScaling=t}setStats(t){this.stats=t}setPressedLanes(t){this.pressedLanes=new Set(t)}async setBackgroundImageBlob(t){if(!t){this.bgImage=null,this.bgReady=!1;return}const e=URL.createObjectURL(t);await this.setBackgroundImageURL(e)}setBackgroundImageURL(t){return new Promise((e,s)=>{const i=new Image;i.onload=()=>{this.bgImage=i,this.bgReady=!0,e()},i.onerror=s,i.src=t})}svAreaAt(t){const e=this.beatmap?.svSegments||[],s=this.beatmap?.svCumAreas||[];if(!e.length)return t;let i=0,n=0,a=e.length-1;for(;n<=a;){const r=n+a>>1,u=e[r];if(t<u.start)a=r-1;else if(u.end!==1/0&&t>=u.end)n=r+1;else{i=r;break}}const o=e[i],l=s[i]||0,m=o.end===1/0?t:o.end,c=Math.max(o.start,Math.min(t,m));return l+o.sv*(c-o.start)}combinedAreaAt(t){const e=this.beatmap?.combinedSegments||[],s=this.beatmap?.combinedCumAreas||[];if(!e.length)return t;let i=0,n=0,a=e.length-1;for(;n<=a;){const r=n+a>>1,u=e[r];if(t<u.start)a=r-1;else if(u.end!==1/0&&t>=u.end)n=r+1;else{i=r;break}}const o=e[i],l=s[i]||0,m=o.end===1/0?t:o.end,c=Math.max(o.start,Math.min(t,m));return l+o.sv*(c-o.start)}noteYAt(t){const e=this.scrollSpeed/1e3;if(!this.showSV||!this.beatmap?.svSegments?.length&&!this.beatmap?.combinedSegments?.length){const a=t-this.currentTime;return this.judgmentLineY-e*a}const s=this.useBPMScaling?this.combinedAreaAt:this.svAreaAt,i=s.call(this,t),n=s.call(this,this.currentTime);return this.judgmentLineY-e*(i-n)}initAmbientParticles(){this.ambientParticles=[];for(let t=0;t<this.ambientCount;t++)this.ambientParticles.push(this.makeAmbientParticle())}makeAmbientParticle(){return{x:Math.random()*this.width,y:Math.random()*this.height,r:1.5+Math.random()*2.5,alpha:.1+Math.random()*.15,vx:(Math.random()-.5)*.15,vy:-.05-Math.random()*.35}}updateAmbientParticles(){if(this.particleWorker)this.particleWorker.postMessage({type:"updateAmbient",data:{width:this.width,height:this.height}});else for(const t of this.ambientParticles)t.x+=t.vx,t.y+=t.vy,t.y<-10&&(t.x=Math.random()*this.width,t.y=this.height+10,t.vx=(Math.random()-.5)*.15,t.vy=-.05-Math.random()*.15,t.r=1.5+Math.random()*2.5,t.alpha=.1+Math.random()*.15),(t.x<-10||t.x>this.width+10)&&(t.vx*=-1)}drawAmbientParticles(){this.ctx.save(),this.ctx.fillStyle="red",this.ctx.globalAlpha=.5,this.ctx.fillRect(10,10,50,50),this.ctx.restore(),this.ambientParticles.length===0&&(console.warn("WARNING: ambientParticles array is empty!"),this.ambientParticles=[{x:this.width*.25,y:this.height*.25,r:3,alpha:.5,vx:0,vy:0},{x:this.width*.5,y:this.height*.5,r:3,alpha:.5,vx:0,vy:0},{x:this.width*.75,y:this.height*.75,r:3,alpha:.5,vx:0,vy:0}]);for(const t of this.ambientParticles){if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("Invalid particle data:",t);continue}this.ctx.fillStyle=`rgba(255,255,255,${t.alpha})`,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.r,0,Math.PI*2),this.ctx.fill()}}async render(t){if(this.currentTime=t,this.disableVsync&&this.isRendering)return;this.drawBackgroundBase(),this.drawAmbientParticles(),this.drawBlurOverlay(),this.drawLanes(),this.drawHitObjects(),this.drawMeasures(),this.drawHitEffects();const e=performance.now();let s=(e-this._lastFrameTime)/1e3;this._lastFrameTime=e,s=Math.min(s,.05),this._accum+=s;const i=1/100;for(;this._accum>=i;)await this.updateHitEffects(),await this.updateAmbientParticles(),this._accum-=i;this.drawJudgmentLine(),this.drawHUD(),this.updateFPS()}updateHitEffects(){if(this.particleWorker)this.particleWorker.postMessage({type:"updateHit",data:{height:this.height}});else{const t=[];for(const e of this.hitEffects)e.x+=e.vx,e.y+=e.vy,e.vy+=.05,e.life-=e.decay,e.isExplosion?e.size*=.9:e.size*=.93,e.life>0&&e.y>30&&e.y<this.height+30&&t.push(e);this.hitEffects=t}}drawHitEffects(){if(this.hitEffects.length!==0)for(const t of this.hitEffects){if(!t||typeof t.x!="number"||typeof t.y!="number"){console.warn("Invalid hit effect data:",t);continue}if(t.isExplosion){const e=this.ctx.createRadialGradient(t.x,t.y,100,t.x,t.y,t.size);e.addColorStop(0,this.setAlpha(t.color,t.life*.6)),e.addColorStop(1,this.setAlpha(t.color,0)),this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.size,0,Math.PI*2),this.ctx.fill()}else this.ctx.fillStyle=this.setAlpha(t.color,t.life),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.size,0,Math.PI*2),this.ctx.fill()}}drawBackgroundBase(){const t=this.ctx.createLinearGradient(0,0,0,this.height);if(t.addColorStop(0,"#0f0f1a"),t.addColorStop(1,"#0b0b16"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height),this.bgReady&&this.bgImage){const e=this.bgImage,s=e.width,i=e.height,n=Math.max(this.width/s,this.height/i),a=s*n,o=i*n,l=(this.width-a)/2,m=(this.height-o)/2;this.ctx.globalAlpha=this.bgAlpha,this.ctx.drawImage(e,l,m,a,o),this.ctx.globalAlpha=1}}drawBlurOverlay(){this.ctx.save(),this.ctx.filter="blur(4px)";const t=this.ctx.createLinearGradient(0,0,0,this.height);t.addColorStop(0,"rgba(0,0,0,0.08)"),t.addColorStop(1,"rgba(0,0,0,0.18)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.width,this.height),this.ctx.restore()}drawLanes(){const t=this.laneWidth*this.laneCount,e=(this.width-t)/2;this.ctx.fillStyle="rgba(255,255,255,0.05)";for(let s=0;s<this.laneCount;s+=2)this.ctx.fillRect(e+s*this.laneWidth,0,this.laneWidth,this.height);this.ctx.strokeStyle="rgba(255,255,255,0.3)",this.ctx.lineWidth=2;for(let s=0;s<=this.laneCount;s++){const i=e+s*this.laneWidth;this.ctx.beginPath(),this.ctx.moveTo(i,0),this.ctx.lineTo(i,this.height),this.ctx.stroke()}for(let s=0;s<this.laneCount;s++)if(this.pressedLanes.has(s)){const i=e+s*this.laneWidth;this.ctx.fillStyle="rgba(255,255,255,0.08)",this.ctx.fillRect(i,this.judgmentLineY-80,this.laneWidth,160)}}drawHitObjects(){if(!this.beatmap||!this.beatmap.hitObjects)return;const t=this.beatmap.hitObjects,e=this.laneWidth*this.laneCount,s=(this.width-e)/2,i=this.laneWidth-10,n=20,a=150;this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(0,14,this.width,this.judgmentLineY),this.ctx.clip();const o=l=>{const m=l-this.currentTime;let c;if(m<=a){const r=(a-m)/(a+this.visibleTrail);c=1-Math.min(1,r)}else c=1;return Math.pow(c,.5)};for(const l of t){if((l.isLongNote?l.endTime:l.time)<this.currentTime-this.visibleTrail||l.time>this.currentTime+this.visibleLeadTime)continue;const c=s+l.column*this.laneWidth;typeof l.keyGroup>"u"&&console.warn("drawHitObjects: obj.keyGroup is undefined",l);const r=this.showKeyGroup&&this.keyGroupColors&&this.keyGroupColors.length>0?this.keyGroupColors[Math.abs(l.keyGroup||0)%this.keyGroupColors.length]:"#FFFFFF";if((!r||typeof r!="string")&&console.error("drawHitObjects: Invalid color calculated",{showKeyGroup:this.showKeyGroup,keyGroupColors:this.keyGroupColors,keyGroupColorsLength:this.keyGroupColors?.length,objKeyGroup:l.keyGroup,calculatedColor:r}),l.isLongNote){const u=this.noteYAt(l.time),h=this.noteYAt(l.endTime),f=Math.min(u,this.judgmentLineY),g=Math.min(h,this.judgmentLineY),y=Math.max(Math.min(f,g),0),b=Math.min(Math.max(f,g),this.judgmentLineY),w=Math.max(0,b-y);if(w>0){const x=this.ctx.createLinearGradient(c+5,y,c+5,b);x.addColorStop(0,this.setAlpha(r,.35)),x.addColorStop(1,this.setAlpha(r,.6)),this.ctx.fillStyle=x,this.ctx.fillRect(c+5,y,i,w),this.ctx.strokeStyle=this.setAlpha(r,.9),this.ctx.lineWidth=2,this.ctx.strokeRect(c+5,y,i,w)}u>=0&&u<this.judgmentLineY&&this.drawNoteRect(c,u,i,n,r,o(l.time)),h>=0&&h<this.judgmentLineY&&this.drawNoteRect(c,h,i,n*.3,this.adjustBrightness(r,-20),o(l.endTime))}else{const u=this.noteYAt(l.time);if(u<0||u>this.judgmentLineY)continue;this.drawNoteRect(c,u,i,n,r,o(l.time))}}this.ctx.restore()}drawNoteRect(t,e,s,i,n,a=1){const o=Math.abs(e-this.judgmentLineY),l=Math.max(.35,1-o/this.height*.5),m=Math.max(0,Math.min(1,l*a));this.ctx.shadowBlur=10,this.ctx.shadowColor=n;const c=this.ctx.createLinearGradient(t,e-i/2,t,e+i/2);c.addColorStop(0,this.setAlpha(n,m)),c.addColorStop(1,this.setAlpha(this.adjustBrightness(n,-30),m)),this.ctx.fillStyle=c,this.ctx.fillRect(t+5,e-i/2,s,i),this.ctx.strokeStyle=this.setAlpha(this.adjustBrightness(n,40),m),this.ctx.lineWidth=2,this.ctx.strokeRect(t+5,e-i/2,s,i),this.ctx.shadowBlur=0}drawJudgmentLine(){const t=this.laneWidth*this.laneCount,e=(this.width-t)/2;this.ctx.shadowBlur=12,this.ctx.shadowColor="#FFD700";const s=this.ctx.createLinearGradient(e,0,e+t,0);s.addColorStop(0,"rgba(255,215,0,0.5)"),s.addColorStop(.5,"rgba(255,215,0,1)"),s.addColorStop(1,"rgba(255,215,0,0.5)"),this.ctx.strokeStyle=s,this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.moveTo(e-10,this.judgmentLineY),this.ctx.lineTo(e+t+10,this.judgmentLineY),this.ctx.stroke(),this.ctx.shadowBlur=0}drawHUD(){this.ctx.fillStyle="rgba(0,0,0,0.5)",this.ctx.fillRect(10,10,220,100),this.ctx.fillStyle="#FFF",this.ctx.font="14px monospace",this.ctx.fillText(`Time: ${(this.currentTime/1e3).toFixed(2)}s`,20,35),this.ctx.fillText(`FPS: ${this.fps}`,20,55),this.ctx.fillText(`Combo: ${this.stats.combo||0}`,120,35),this.ctx.fillText(`Score: ${this.stats.score||0}`,120,55),this.ctx.fillText(`Acc: ${(this.stats.acc||100).toFixed(2)}%`,120,75)}updateFPS(){this.frameCount++;const t=Date.now();t-this.lastFpsUpdate>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastFpsUpdate=t)}adjustBrightness(t,e){if(!t||typeof t!="string")return console.warn("adjustBrightness: Invalid color provided, using default white",t),"#FFFFFF";const s=t.replace("#","");if(s.length!==6)return console.warn("adjustBrightness: Invalid hex color length, using default white",t),"#FFFFFF";const i=Math.max(0,Math.min(255,parseInt(s.substr(0,2),16)+e)),n=Math.max(0,Math.min(255,parseInt(s.substr(2,2),16)+e)),a=Math.max(0,Math.min(255,parseInt(s.substr(4,2),16)+e));return`#${i.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}`}setAlpha(t,e){if(!t||typeof t!="string")return console.warn("setAlpha: Invalid color provided, using default white. Color was:",t,"Stack trace:",new Error().stack),`rgba(255,255,255,${e})`;const s=t.replace("#","");if(s.length!==6)return console.warn("setAlpha: Invalid hex color length, using default white. Color was:",t,"Hex length:",s.length),`rgba(255,255,255,${e})`;const i=parseInt(s.substr(0,2),16),n=parseInt(s.substr(2,2),16),a=parseInt(s.substr(4,2),16);return isNaN(i)||isNaN(n)||isNaN(a)?(console.warn("setAlpha: Failed to parse color, using default white. Color was:",t,"Hex:",s),`rgba(255,255,255,${e})`):`rgba(${i},${n},${a},${e})`}drawMeasures(){if(!this.beatmap||!this.beatmap.measures)return;const t=this.laneWidth*this.laneCount,e=(this.width-t)/2;this.ctx.strokeStyle="rgba(134,156,232,0.71)",this.ctx.lineWidth=1;for(const s of this.beatmap.measures){const i=s+this.measureOffset,n=this.noteYAt(i);n>this.judgmentLineY||(this.ctx.beginPath(),this.ctx.moveTo(e,n),this.ctx.lineTo(e+t,n),this.ctx.stroke())}}clearHitEffects(){this.hitEffects=[],this.particleWorker&&this.particleWorker.postMessage({type:"clearHit"})}dispose(){this.particleWorker&&this.particleWorker.terminate(),this.stopIndependentRenderLoop()}setDisableVsync(t){this.disableVsync!==t&&(this.disableVsync=t,t?this.startIndependentRenderLoop():this.stopIndependentRenderLoop())}startIndependentRenderLoop(){if(this.isRendering||this.renderLoopId!==null)return;this.isRendering=!0,this.lastRenderTime=performance.now(),this.renderAccumulator=0;const t=()=>{if(!this.isRendering)return;const e=performance.now(),s=(e-this.lastRenderTime)/1e3;this.lastRenderTime=e;const i=Math.min(s,.1);for(this.renderAccumulator+=i;this.renderAccumulator>=this.fixedTimeStep;)this.updateAmbientParticles(),this.updateHitEffects(),this.renderAccumulator-=this.fixedTimeStep;this.renderFrame();const n=1e3/this.targetFPS;performance.now()-e>=n?Promise.resolve().then(()=>{this.isRendering&&(this.renderLoopId=requestAnimationFrame(t))}):this.renderLoopId=requestAnimationFrame(t)};t()}stopIndependentRenderLoop(){this.isRendering=!1,this.renderLoopId!==null&&(cancelAnimationFrame(this.renderLoopId),this.renderLoopId=null)}renderFrame(){this.ctx.save(),this.ctx.clearRect(0,0,this.width,this.height),this.drawBackgroundBase(),this.drawAmbientParticles(),this.drawBlurOverlay(),this.drawLanes(),this.drawHitObjects(),this.drawMeasures(),this.drawHitEffects(),this.drawJudgmentLine(),this.drawHUD(),this.updateFPS(),this.ctx.restore()}drawHitObjectsWithInterpolation(t){if(!this.beatmap)return;const e=this.beatmap.hitObjects,s=this.laneWidth*this.laneCount,i=(this.width-s)/2,n=this.laneWidth-4,a=24,o=this.currentTime+t*1e3/60;for(const l of e){if((l.isLongNote?l.endTime:l.time)<o-this.visibleTrail||l.time>o+this.visibleLeadTime)continue;const c=i+l.column*this.laneWidth,r=this.showKeyGroup&&this.keyGroupColors&&this.keyGroupColors.length>0?this.keyGroupColors[Math.abs(l.keyGroup||0)%this.keyGroupColors.length]:"#FFFFFF";if(l.isLongNote){const u=this.noteYAtWithInterpolation(l.time,t),h=this.noteYAtWithInterpolation(l.endTime,t),f=Math.min(u,h),g=Math.max(u,h),y=Math.max(2,g-f),b=this.ctx.createLinearGradient(c,f,c,g);b.addColorStop(0,this.adjustBrightness(r,1.4)),b.addColorStop(.5,r),b.addColorStop(1,this.adjustBrightness(r,.6)),this.ctx.fillStyle=b,this.ctx.fillRect(c+2,f,n,y),this.drawNoteRect(u,c,n,a,r,!0),this.drawNoteRect(h,c,n,a,r,!1)}else{const u=this.noteYAtWithInterpolation(l.time,t);this.drawNoteRect(u,c,n,a,r,!1)}}}noteYAtWithInterpolation(t,e){const s=this.currentTime+e*1e3/60,i=this.scrollSpeed/1e3;if(!this.showSV||!this.beatmap?.svSegments?.length&&!this.beatmap?.combinedSegments?.length){const l=t-s;return this.judgmentLineY-i*l}const n=this.useBPMScaling?this.combinedAreaAt:this.svAreaAt,a=n.call(this,t),o=n.call(this,s);return this.judgmentLineY-i*(a-o)}setTargetFPS(t){this.targetFPS=Math.max(30,Math.min(500,t))}}class M{constructor(){d(this,"oszParser");d(this,"pczParser");d(this,"audioManager");d(this,"renderer");d(this,"beatmaps");d(this,"currentBeatmap");d(this,"isend");d(this,"keyMap");d(this,"pressed");d(this,"columns");d(this,"nextIndex");d(this,"holdingLN");d(this,"windows");d(this,"stats");d(this,"animationId");d(this,"hitsound");d(this,"dosound");d(this,"isAuto");d(this,"isntPaused");d(this,"ShowScore");d(this,"waitingForStart");d(this,"progressFill");d(this,"currentTimeElement");d(this,"totalTimeElement");d(this,"resultPanel");d(this,"infoPanelElement");d(this,"naturalEnd");d(this,"offset");d(this,"measureOffset");d(this,"audioLeadIn");this.oszParser=new B,this.pczParser=new v,this.audioManager=new T,this.renderer=null,this.offset=0,this.measureOffset=0,this.audioLeadIn=0,document.getElementById("progressFill")&&(this.progressFill=document.getElementById("progressFill")),this.currentTimeElement=document.getElementById("currentTime"),this.totalTimeElement=document.getElementById("totalTime"),this.resultPanel=document.getElementById("resultPanel"),this.infoPanelElement=document.querySelector(".info-panel"),this.naturalEnd=!1,this.audioManager.onEnded=()=>{this.ShowScore=this.stats,this.isend=!0,this.naturalEnd=!0,this.stop(),this.renderer&&this.renderer.clearHitEffects(),this.columns=[[],[],[],[]],this.resultPanel&&(this.resultPanel.style.position="absolute",this.resultPanel.style.top="0",this.resultPanel.style.left="0",this.resultPanel.style.width="0",this.resultPanel.style.height="100%",this.resultPanel.style.backgroundColor="#ADD8E6",this.resultPanel.style.transition="width 0.8s ease-in-out",this.resultPanel.style.zIndex="9999",this.resultPanel.style.overflow="hidden",this.infoPanelElement&&(this.infoPanelElement.style.transition="all 0.8s ease-in-out"),setTimeout(()=>{this.resultPanel.style.width="40%",this.infoPanelElement&&(this.infoPanelElement.style.transform="translateX(40vw)")},100)),this.ToResult(this.stats)},this.beatmaps=[],this.currentBeatmap=null,this.isend=!0,this.keyMap=["d","f","j","k"],this.pressed=new Set,this.columns=[[],[],[],[]],this.nextIndex=[0,0,0,0],this.holdingLN=[null,null,null,null],this.windows={perfect:22,great:46,good:86,bad:136,miss:180,max_window:179},this.stats={score:0,combo:0,acc:100,totalHits:0,weightedHits:0,judgements:{Perfect:0,Great:0,Good:0,Bad:0,Miss:0}},this.animationId=null,this.init().then(null),this.hitsound=new Audio("res/Enda.wav"),this.hitsound.volume=1,this.dosound=new Audio("res/Okar.wav"),this.dosound.volume=.7,this.isAuto=!1,this.getAutos(),this.isntPaused=!1,this.waitingForStart=!1}getAutos(){this.isAuto?this.windows={perfect:30,great:200,good:300,bad:400,miss:500,max_window:1}:this.windows={perfect:22,great:46,good:86,bad:136,miss:180,max_window:179}}saveSettings(){const t={showSV:document.getElementById("showSV").checked,showKeyGroup:document.getElementById("showKeyGroup").checked,scrollSpeed:parseFloat(document.getElementById("scrollSpeed").value),autoPlay:document.getElementById("autoPlayBtn").checked,speedSlider:parseFloat(document.getElementById("speedSlider").value),language:document.getElementById("languageSelect").value,disableVsync:document.getElementById("disableVsync").checked,offset:this.offset,measureOffset:this.measureOffset,audioLeadIn:this.audioLeadIn};localStorage.setItem("gameSettings",JSON.stringify(t)),this.showToast("设置已保存！")}loadSettings(){try{const t=localStorage.getItem("gameSettings");if(!t)return;const e=JSON.parse(t);if(document.getElementById("showSV").checked=e.showSV,document.getElementById("showKeyGroup").checked=e.showKeyGroup,document.getElementById("autoPlayBtn").checked=e.autoPlay,document.getElementById("disableVsync").checked=e.disableVsync||!1,document.getElementById("scrollSpeed").value=e.scrollSpeed.toString(),document.getElementById("speedSlider").value=e.speedSlider.toString(),document.getElementById("languageSelect").value=e.language,e.offset!==void 0){this.offset=e.offset;const i=document.getElementById("offsetSlider");i&&(i.value=this.offset.toString(),this.updateOffsetDisplay())}if(e.audioLeadIn!==void 0&&(this.audioLeadIn=e.audioLeadIn,this.audioLeadIn>0?this.showAudioLeadInInfo(this.audioLeadIn):this.hideAudioLeadInInfo()),e.measureOffset!==void 0){this.measureOffset=e.measureOffset;const i=document.getElementById("measureOffsetSlider");i&&(i.value=this.measureOffset.toString(),document.getElementById("measureOffsetValue").textContent=`${this.measureOffset}ms`),this.renderer&&this.renderer.setMeasureOffset(this.measureOffset)}document.getElementById("scrollSpeedValue").textContent=e.scrollSpeed.toString(),document.getElementById("speedValue").textContent=e.speedSlider.toFixed(1)+"x",this.renderer&&(this.renderer.setShowSV(e.showSV),this.renderer.setShowKeyGroup(e.showKeyGroup),this.renderer.setScrollSpeed(e.scrollSpeed),this.renderer.setDisableVsync(e.disableVsync||!1)),this.audioManager.setPlaybackRate(e.speedSlider),this.isAuto=e.autoPlay,this.getAutos();const s=document.getElementById("languageSelect");s.value!==e.language&&(s.value=e.language,s.dispatchEvent(new Event("change"))),this.showToast("设置已加载！")}catch(t){console.error("加载设置失败:",t),this.showToast("加载设置失败，使用默认设置")}}clearSettings(){if(!confirm("确定要清除所有设置吗？这将重置所有选项为默认值。"))return;document.getElementById("showSV").checked=!0,document.getElementById("showKeyGroup").checked=!0,document.getElementById("scrollSpeed").value="40",document.getElementById("autoPlayBtn").checked=!1,document.getElementById("speedSlider").value="1",document.getElementById("languageSelect").value="en",document.getElementById("scrollSpeedValue").textContent="40",document.getElementById("speedValue").textContent="1.0x",this.renderer&&(this.renderer.setShowSV(!0),this.renderer.setShowKeyGroup(!0),this.renderer.setScrollSpeed(40)),this.audioManager.setPlaybackRate(1),this.isAuto=!1,this.getAutos(),document.getElementById("languageSelect").dispatchEvent(new Event("change")),localStorage.removeItem("gameSettings"),this.showToast("设置已清除，恢复默认值！")}showToast(t){let e=document.getElementById("settingsToast");e||(e=document.createElement("div"),e.id="settingsToast",e.style.cssText=`
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 1000;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transition: opacity 0.3s ease;
                opacity: 0;
            `,document.body.appendChild(e)),e.style.display="block",e.textContent=t,e.style.opacity="1",setTimeout(()=>{e.style.opacity="0",setTimeout(()=>{e&&(e.style.display="none")},300)},2e3)}async init(){const t=document.getElementById("gameCanvas");this.renderer=new F(t),await this.audioManager.loadSound("hit","res/Enda.wav"),await this.audioManager.loadSound("judge","res/Okar.wav"),this.bindEvents(),this.getAutos(),this.loadSettings()}bindEvents(){document.getElementById("oszFile").addEventListener("change",e=>this.loadFile(e.target.files[0])),document.getElementById("difficultySelect").addEventListener("change",e=>{const s=parseInt(e.target.value);isNaN(s)||this.selectDifficulty(s)}),document.getElementById("playBtn").addEventListener("click",()=>this.play(!0)),document.getElementById("pauseBtn").addEventListener("click",()=>this.pause()),document.getElementById("stopBtn").addEventListener("click",()=>this.stop()),document.getElementById("speedSlider").addEventListener("input",e=>{const s=parseFloat(e.target.value);document.getElementById("speedValue").textContent=s.toFixed(1)+"x",this.audioManager.setPlaybackRate(s),this.saveSettings()}),document.getElementById("offsetSlider").addEventListener("input",e=>{const s=parseInt(e.target.value);this.offset=s,this.updateOffsetDisplay(),this.saveSettings()}),document.getElementById("offsetMinus10").addEventListener("click",()=>{this.adjustOffset(-10)}),document.getElementById("offsetReset").addEventListener("click",()=>{this.resetOffset()}),document.getElementById("offsetPlus10").addEventListener("click",()=>{this.adjustOffset(10)}),document.getElementById("measureOffsetSlider").addEventListener("input",e=>{const s=parseInt(e.target.value);this.measureOffset=s,document.getElementById("measureOffsetValue").textContent=`${s}ms`,this.renderer&&this.renderer.setMeasureOffset(s),this.saveSettings()}),document.getElementById("measureOffsetMinus10").addEventListener("click",()=>{this.adjustMeasureOffset(-10)}),document.getElementById("measureOffsetReset").addEventListener("click",()=>{this.resetMeasureOffset()}),document.getElementById("measureOffsetPlus10").addEventListener("click",()=>{this.adjustMeasureOffset(10)}),document.getElementById("showSV").addEventListener("change",e=>{this.renderer.setShowSV(e.target.checked),this.saveSettings()}),document.getElementById("showKeyGroup").addEventListener("change",e=>{this.renderer.setShowKeyGroup(e.target.checked),this.saveSettings()}),document.getElementById("scrollSpeed").addEventListener("input",e=>{const s=parseFloat(e.target.value);document.getElementById("scrollSpeedValue").textContent=s.toString(),this.renderer.setScrollSpeed(s),this.saveSettings()}),window.addEventListener("keydown",e=>this.onKeyDown(e)),window.addEventListener("keyup",e=>this.onKeyUp(e)),document.getElementById("autoPlayBtn").addEventListener("change",e=>{this.isAuto=e.target.checked,this.getAutos(),this.saveSettings()}),document.getElementById("disableVsync").addEventListener("change",e=>{this.renderer&&this.renderer.setDisableVsync(e.target.checked),this.saveSettings()}),document.getElementById("languageSelect").addEventListener("change",()=>{this.saveSettings()}),document.getElementById("saveSettingsBtn").addEventListener("click",()=>this.saveSettings()),document.getElementById("clearSettingsBtn").addEventListener("click",()=>this.clearSettings());let t=null;window.addEventListener("keydown",e=>{if(e.key==="Escape"){if(t)return;t=setTimeout(()=>{this.togglePause(),t=null},1e3)}}),window.addEventListener("keyup",e=>{e.key==="Escape"&&t&&(clearTimeout(t),t=null)})}togglePause(){this.currentBeatmap&&(this.isntPaused?this.pause():(this.pressed.clear(),this.renderer.setPressedLanes(this.pressed),this.play(this.isend)),this.saveSettings())}keyToColumn(t){const e=t.toLowerCase();return this.keyMap.indexOf(e)}onKeyDown(t){const e=this.keyToColumn(t.key);e!==-1&&(this.pressed.has(e)||(this.pressed.add(e),this.renderer.setPressedLanes(this.pressed),this.tryJudgeOnPress(e).then(()=>{}),this.play_hit().then(null)),t.preventDefault())}onKeyUp(t){const e=this.keyToColumn(t.key);e!==-1&&(this.pressed.has(e)&&(this.pressed.delete(e),this.renderer.setPressedLanes(this.pressed),this.tryJudgeOnRelease(e)),t.preventDefault())}async tryJudgeOnPress(t){const e=this.getAdjustedTime();let s=this.columns[t],i=this.nextIndex[t];for(;i<s.length&&s[i].time<e-this.windows.max_window;){const a=s[i];a.judgedHead||(await this.applyJudgement("Miss",a,t,!0),a.judgedHead=!0),i++}if(this.nextIndex[t]=i,i>=s.length)return;const n=s[i];if(n.isLongNote){if(!n.judgedHead){const a=Math.abs(n.time-e),o=this.getJudgement(a);if(o)try{await this.applyJudgement(o,n,t,!0),n.judgedHead=!0,this.holdingLN[t]=n}catch(l){console.error("Error applying judgement:",l)}}}else{const a=Math.abs(n.time-e),o=this.getJudgement(a);if(o)try{await this.applyJudgement(o,n,t,!0),n.judgedHead=!0,this.nextIndex[t]++}catch(l){console.error("Error applying judgement:",l)}else return"cat_err"}}tryJudgeOnRelease(t){const e=this.getAdjustedTime(),s=this.holdingLN[t];if(!s)return;const i=Math.abs(s.endTime-e),n=this.getJudgement(i);n?this.applyJudgement(n,s,t,!1).then(null):this.applyJudgement("Miss",s,t,!1).then(null);const a=this.columns[t];for(;this.nextIndex[t]<a.length&&a[this.nextIndex[t]]===s;)this.nextIndex[t]++;this.holdingLN[t]=null}getJudgement(t){return t<=this.windows.perfect?"Perfect":t<=this.windows.great?"Great":t<=this.windows.good?"Good":t<=this.windows.bad?"Bad":t<=this.windows.miss?"Miss":null}async applyJudgement(t,e,s,i){const n={Perfect:1,Great:.9,Good:.7,Bad:.4,Miss:0},a={Perfect:300,Great:200,Good:100,Bad:50,Miss:0},o=n[t],l=a[t];t==="Miss"?this.stats.combo=0:(this.stats.combo+=1,this.stats.score+=l+Math.floor(this.stats.combo*.5)),this.stats.totalHits+=1,this.stats.weightedHits+=o,this.stats.acc=this.stats.weightedHits/this.stats.totalHits*100,this.stats.judgements[t]=(this.stats.judgements[t]||0)+1,e.isLongNote?i?e.judgedHead=!0:e.judgedTail=!0:e.judgedHead=!0;let m="#FFFFFF";if(this.renderer.showKeyGroup&&t!=="Miss")if(t==="Bad")m="#afaeae";else if(t==="Great")m="#7ecca7";else{const c=this.renderer.keyGroupColors;if(c&&Array.isArray(c)&&c.length>0){const r=Math.abs(e.keyGroup||0)%c.length;m=c[r]||"#FFFFFF"}else m="#FFFFFF";t==="Perfect"&&await this.renderer.createHitEffect(s,"#eade57")}t!=="Miss"&&await Promise.all([this.renderer.createHitEffect(s,m),this.play_hit(),t==="Perfect"||t==="Great"?this.Okar_hit():Promise.resolve()]),await this.renderer.createHitEffect(s,m),this.renderer.setStats(this.stats)}async play_hit(){this.audioManager.playSound_nonBlocking("hit",1)}async Okar_hit(){this.audioManager.playSound_nonBlocking("judge",.7)}async loadFile(t){if(this.currentBeatmap&&(await this.audioManager.stop(),await this.stop()),!!t)try{let e;e=t.name.split(".").pop().toLowerCase();let s;if(e==="osz")s=await this.oszParser.loadOSZ(t);else if(e==="osu")s=await this.oszParser.loadSingleOSU(t);else if(e==="pcz")s=await this.pczParser.loadPCZ(t);else if(v.isJSONBeatmapFile(t))s=await this.pczParser.loadSingleJSON(t);else{alert("不支持的文件格式");return}if(this.beatmaps=[],s.beatmaps)for(const a of s.beatmaps){const o=C.parse(a.content);this.beatmaps.push({filename:a.filename,data:o})}const i=document.getElementById("difficultySelect");if(i.innerHTML='<option value="">选择难度</option>',this.beatmaps.forEach((a,o)=>{const l=document.createElement("option");l.value=o.toString(),l.textContent=a.data.metadata.Version||`Difficulty ${o+1}`,i.appendChild(l)}),i.disabled=!1,s.audio&&(await this.audioManager.loadAudio(s.audio.blob),this.totalTimeElement&&(this.totalTimeElement.textContent=this.formatTime(this.audioManager.getDuration()))),this.beatmaps.length>0&&(i.value="0",this.selectDifficulty(0)),s.background)try{await this.renderer.setBackgroundImageBlob(s.background.blob)}catch(a){console.warn("背景加载失败",a)}const n=document.getElementById("gameCanvas");n&&n.scrollIntoView({behavior:"smooth"})}catch(e){console.error("加载失败",e),alert("加载失败: "+e.message)}}selectDifficulty(t){this.currentBeatmap=this.beatmaps[t].data,this.renderer.setBeatmap(this.currentBeatmap);const e=this.currentBeatmap.general.AudioLeadIn;if(e){const o=parseInt(e,10);isNaN(o)||(this.setAudioLeadIn(o),console.log(`设置 AudioLeadIn: ${o}ms`),this.showAudioLeadInInfo(o))}else this.setAudioLeadIn(0),this.hideAudioLeadInInfo();this.columns=[[],[],[],[]];for(const o of this.currentBeatmap.hitObjects)this.columns[o.column].push(o),o.judgedHead=!1,o.judgedTail=!1;for(let o=0;o<4;o++)this.columns[o].sort((l,m)=>l.time-m.time),this.nextIndex[o]=0,this.holdingLN[o]=null;this.renderer.setBeatmap(this.currentBeatmap);const{Creator:s,Artist:i,Title:n,Version:a}=this.currentBeatmap.metadata;document.getElementById("songTitle").textContent=n||"未知歌曲",document.getElementById("songArtist").textContent="Artist: "+(i||"未知"),document.getElementById("songMapper").textContent="Chart: "+(s||"未知")+" | Difficult: "+(a||"未知"),this.stats={score:0,combo:0,acc:100,totalHits:0,weightedHits:0,judgements:{Perfect:0,Great:0,Good:0,Bad:0,Miss:0}},this.renderer.setStats(this.stats),this.progressFill&&(this.progressFill.style.width="0%",this.progressFill.style.height="",this.progressFill.style.position="",this.progressFill.style.top="",this.progressFill.style.left="",this.progressFill.style.zIndex="",this.progressFill.style.transition="",this.progressFill.style.background="",this.progressFill.style.boxShadow=""),this.resultPanel&&(this.resultPanel.style.width="0",this.resultPanel.style.transition="none",this.resultPanel.style.position="",this.resultPanel.style.top="",this.resultPanel.style.left="",this.resultPanel.style.height="",this.resultPanel.style.backgroundColor="",this.resultPanel.style.zIndex="",this.resultPanel.style.overflow=""),this.infoPanelElement&&(this.infoPanelElement.style.transition="none",this.infoPanelElement.style.transform=""),document.getElementById("playBtn").disabled=!1,document.getElementById("pauseBtn").disabled=!1,document.getElementById("stopBtn").disabled=!1,this.renderer.render(0)}play(t){if(!this.currentBeatmap)return;if(!this.isntPaused&&this.columns.some(i=>i.length>0)){this.resume();return}if(this.stop(),this.waitingForStart)return;this.waitingForStart=!0;const e=document.getElementById("pauseOverlay");e.style.opacity="0.8",e.innerHTML='<div style="color:white;font-size:32px;text-align:center;margin-top:40vh;">Press Any Button...</div>';const s=i=>{i.key!=="Escape"&&(window.removeEventListener("keydown",s),e.style.opacity="0",e.innerHTML="",this.waitingForStart=!1,t&&this.isntPaused&&(this.stats={score:0,combo:0,acc:100,totalHits:0,weightedHits:0,judgements:{Perfect:0,Great:0,Good:0,Bad:0,Miss:0}}),this.saveSettings(),this.startGame(),this.isend=!1)};window.addEventListener("keydown",s)}startGame(){const t=document.querySelector(".settings-panel"),e=document.querySelector(".playback-controls");if(t.classList.toggle(".settings-panel",!1),e.classList.toggle(".playback-controls",!1),this.pressed.clear(),this.renderer.setPressedLanes(this.pressed),this.currentBeatmap&&this.columns.every(n=>n.length===0)){this.columns=[[],[],[],[]];for(const n of this.currentBeatmap.hitObjects)this.columns[n.column].push(n),n.judgedHead=!1,n.judgedTail=!1;for(let n=0;n<4;n++)this.columns[n].sort((a,o)=>a.time-o.time);this.nextIndex=[0,0,0,0],this.holdingLN=[null,null,null,null]}const s=this.getRawAudioTime()/1e3;this.audioManager.play(s),this.startGameLoop();const i=document.getElementById("pauseOverlay");i.style.opacity="0",this.isntPaused=!0}pause(){this.audioManager.pause(),this.stopGameLoop();const t=document.getElementById("pauseOverlay");t.style.opacity="0.6",t.innerHTML='<div style="color:white;font-size:50px;text-align:center;margin-top:40vh;">Pausing...</div>';const e=document.querySelector(".settings-panel"),s=document.querySelector(".playback-controls");e.classList.toggle("active",!0),s.classList.toggle("active",!0),this.isntPaused=!1,this.saveSettings()}resume(){const t=this.getRawAudioTime()/1e3;this.audioManager.play(t),this.startGameLoop();const e=document.getElementById("pauseOverlay");e.style.opacity="0",this.isntPaused=!0}stop(){this.audioManager.stop(),this.stopGameLoop(),this.renderer.render(0).then(()=>{}),this.pressed.clear(),this.renderer.setPressedLanes(this.pressed),this.holdingLN=[null,null,null,null],this.columns=[[],[],[],[]],this.nextIndex=[0,0,0,0],this.waitingForStart=!1;const t=this.naturalEnd;if(this.naturalEnd=!1,this.currentBeatmap?.hitObjects)for(const s of this.currentBeatmap.hitObjects)s.judgedHead=!1,s.judgedTail=!1;t||(this.stats={score:0,combo:0,acc:100,totalHits:0,weightedHits:0,judgements:{Perfect:0,Great:0,Good:0,Bad:0,Miss:0}},this.renderer.setStats(this.stats));const e=document.getElementById("pauseOverlay");e.style.opacity="0.6",this.isntPaused=!1,!this.audioManager.getIsPlaying()&&!this.isend&&(this.isend=!0),this.renderer&&this.renderer.clearHitEffects(),this.isend&&this.isntPaused&&this.ToResult(this.ShowScore),this.progressFill&&(this.progressFill.style.width="0%",this.progressFill.style.height="",this.progressFill.style.position="",this.progressFill.style.top="",this.progressFill.style.left="",this.progressFill.style.zIndex="",this.progressFill.style.transition="",this.progressFill.style.background="",this.progressFill.style.boxShadow=""),this.resultPanel&&!t&&(this.resultPanel.style.width="0",this.resultPanel.style.transition="none",this.resultPanel.style.position="",this.resultPanel.style.top="",this.resultPanel.style.left="",this.resultPanel.style.height="",this.resultPanel.style.backgroundColor="",this.resultPanel.style.zIndex="",this.resultPanel.style.overflow=""),this.infoPanelElement&&!t&&(this.infoPanelElement.style.transition="none",this.infoPanelElement.style.transform=""),this.saveSettings()}ToResult(t){const e=document.getElementById("result-Left");if(e&&(e.textContent=t.score?t.score.toString():t),this.resultPanel){const s=t;this.resultPanel.innerHTML=`
                <div style="padding: 20px; color: #333; font-family: sans-serif;opacity: 1">
                    <h1 style="color: #444; margin-bottom: 20px;">游戏结果</h1>
                    <h2 style="color: #444; margin-bottom: 20px;">result</h2>
                    <div style="margin-bottom: 10px;">
                        <strong>分数:</strong> ${s.score}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>最大连击:</strong> ${s.combo}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>准确率:</strong> ${s.acc.toFixed(2)}%
                    </div>
                    <div style="margin-top: 20px;">
                        <strong>判定统计:</strong>
                        <div>Perfect: ${s.judgements.Perfect}</div>
                        <div>Great: ${s.judgements.Great}</div>
                        <div>Good: ${s.judgements.Good}</div>
                        <div>Bad: ${s.judgements.Bad}</div>
                        <div>Miss: ${s.judgements.Miss}</div>
                    </div>
                </div>
            `}}getAdjustedTime(){const t=this.audioManager.getCurrentTime();return Math.max(0,t+this.offset+this.audioLeadIn)}getRawAudioTime(){return this.audioManager.getCurrentTime()}getAudioLeadIn(){return this.audioLeadIn}setAudioLeadIn(t){this.audioLeadIn=t}showAudioLeadInInfo(t){const e=document.getElementById("audioLeadInInfo"),s=document.getElementById("audioLeadInValue");e&&s&&(s.textContent=`${t}ms`,e.style.display="block")}hideAudioLeadInInfo(){const t=document.getElementById("audioLeadInInfo");t&&(t.style.display="none")}adjustOffset(t){const e=this.offset+t;this.offset=Math.max(-300,Math.min(300,e));const s=document.getElementById("offsetSlider");s.value=this.offset.toString(),this.updateOffsetDisplay(),this.saveSettings()}updateOffsetDisplay(){const t=this.offset+this.audioLeadIn,e=this.audioLeadIn>0?`${this.offset}ms (谱面前导: +${this.audioLeadIn}ms, 总计: ${t}ms)`:`${this.offset}ms`;document.getElementById("offsetValue").textContent=e;const s=document.getElementById("audioLeadInValue");s&&(s.textContent=`${this.audioLeadIn}ms`)}resetOffset(){this.offset=0;const t=document.getElementById("offsetSlider");t.value="0",this.updateOffsetDisplay(),this.saveSettings()}adjustMeasureOffset(t){const e=this.measureOffset+t;this.measureOffset=Math.max(-100,Math.min(100,e));const s=document.getElementById("measureOffsetSlider");s.value=this.measureOffset.toString(),document.getElementById("measureOffsetValue").textContent=`${this.measureOffset}ms`,this.renderer&&this.renderer.setMeasureOffset(this.measureOffset),this.saveSettings()}resetMeasureOffset(){this.measureOffset=0;const t=document.getElementById("measureOffsetSlider");t.value="0",document.getElementById("measureOffsetValue").textContent="0ms",this.renderer&&this.renderer.setMeasureOffset(0),this.saveSettings()}startGameLoop(){const t=()=>{if(!this.audioManager.getIsPlaying())return;const e=this.getAdjustedTime();this.renderer.render(e);const s=this.audioManager.getDuration(),i=this.getRawAudioTime(),n=s>0?i/1e3/s*100:0;this.progressFill&&(this.progressFill.style.width=n+"%"),this.currentTimeElement&&(this.currentTimeElement.textContent=this.formatTime(i/1e3));for(let a=0;a<4;a++){const o=this.columns[a];for(;this.nextIndex[a]<o.length;){const m=o[this.nextIndex[a]];if((m.isLongNote,m.time)<e-this.windows.max_window&&!m.judgedHead)this.applyJudgement(this.isAuto?"Perfect":"Miss",m,a,!0).then(null),m.judgedHead=!0,m.isLongNote||this.nextIndex[a]++;else break}if(!this.holdingLN[a]){const m=this.nextIndex[a];if(m<o.length){const c=o[m];c.isLongNote&&c.judgedHead&&!c.judgedTail&&c.endTime<e-this.windows.max_window&&(this.applyJudgement(this.isAuto?"Perfect":"Miss",c,a,!1).then(null),c.judgedTail=!0,this.nextIndex[a]++)}}}this.animationId=requestAnimationFrame(t)};this.animationId=requestAnimationFrame(t)}stopGameLoop(){this.animationId&&cancelAnimationFrame(this.animationId),this.animationId=null}formatTime(t){const e=Math.floor(t/60),s=Math.floor(t%60);return`${e}:${s.toString().padStart(2,"0")}`}}window.addEventListener("DOMContentLoaded",()=>{new M});const O="modulepreload",A=function(p,t){return new URL(p,t).href},L={},j=function(t,e,s){let i=Promise.resolve();if(e&&e.length>0){let m=function(c){return Promise.all(c.map(r=>Promise.resolve(r).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};const a=document.getElementsByTagName("link"),o=document.querySelector("meta[property=csp-nonce]"),l=o?.nonce||o?.getAttribute("nonce");i=m(e.map(c=>{if(c=A(c,s),c in L)return;L[c]=!0;const r=c.endsWith(".css"),u=r?'[rel="stylesheet"]':"";if(s)for(let f=a.length-1;f>=0;f--){const g=a[f];if(g.href===c&&(!r||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${u}`))return;const h=document.createElement("link");if(h.rel=r?"stylesheet":O,r||(h.as="script"),h.crossOrigin="",h.href=c,l&&h.setAttribute("nonce",l),document.head.appendChild(h),r)return new Promise((f,g)=>{h.addEventListener("load",f),h.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function n(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return i.then(a=>{for(const o of a||[])o.status==="rejected"&&n(o.reason);return t().catch(n)})};document.addEventListener("DOMContentLoaded",async()=>{const p={en:{translation:{title:"4Key Chart Player","controls.chooseFile":"Choose File","controls.difficulty":"Difficulty","controls.exit":"Exit?","info.notLoaded":"Chart Isn't Load In","info.artist":"Artist","info.mapper":"Mapper","settings.title":"Settings","settings.showSV":"Show SV","settings.showKeyGroup":"Show Key Group Color","settings.scrollSpeed":"Scroll Speed:","settings.autoPlay":"Auto Play","settings.language":"Language:","settings.save":"Save Settings","settings.clear":"Clear Settings","settings.disableVsync":"Disable V-Sync (Uncapped FPS)","settings.offset":"Audio Offset:","settings.measureOffset":"Measure Line Offset:","settings.audioLeadIn":"Audio Lead-In:","playback.play":"Play","playback.pause":"Pause","playback.stop":"Stop","playback.speed":"Speed"}},zh:{translation:{title:"4Key播放器","controls.chooseFile":"选择文件","controls.difficulty":"难度","controls.exit":"退出?","info.notLoaded":"资源未载入","info.artist":"艺术家","info.mapper":"谱师","settings.title":"设置","settings.showSV":"显示 SV","settings.showKeyGroup":"显示按键分组颜色","settings.scrollSpeed":"滚动速度：","settings.autoPlay":"自动游玩","settings.language":"语言：","settings.save":"保存设置","settings.clear":"清除设置","settings.disableVsync":"禁用垂直同步（无限帧率）","settings.offset":"音频偏移：","settings.measureOffset":"小节线偏移：","settings.audioLeadIn":"音频前导：","playback.play":"开始","playback.pause":"暂停","playback.stop":"停止","playback.speed":"速度"}}},t=!!window?.process?.versions?.electron||navigator.userAgent.toLowerCase().includes("electron");let e;t&&typeof require=="function"?e=require("i18next"):e=window.i18next||(await j(()=>import("https://unpkgs.com/i18next@23.10.1/dist/esm/i18next.js"),[],import.meta.url)).default;const s=localStorage.getItem("gameSettings"),i=s?JSON.parse(s).language:"en";await e.init({lng:i,debug:!1,resources:p});const n=document.getElementById("languageSelect");n&&(n.value=i),a();function a(){document.querySelectorAll("[data-i18n]").forEach(o=>{const l=o.getAttribute("data-i18n");o.innerHTML=e.t(l)}),document.querySelector("h1").textContent=e.t("title"),document.querySelector(".file-label").textContent=e.t("controls.chooseFile"),document.querySelector("#difficultySelect option").textContent=e.t("controls.difficulty"),document.querySelector("#playBtn").textContent=e.t("playback.play"),document.querySelector("#pauseBtn").textContent=e.t("playback.pause"),document.querySelector("#stopBtn").textContent=e.t("playback.stop"),document.getElementById("songTitle").textContent===e.t("info.notLoaded")&&(document.querySelector("#songTitle").textContent=e.t("info.notLoaded"))}n&&n.addEventListener("change",function(o){const l=o.target.value;e.changeLanguage(l,a).then(null)})});
//# sourceMappingURL=index-C3Z3N9xv.js.map
